{% extends "base.html" %}
{% block content %}

<h3 style="text-align:center;">Upload Your Image</h3>

<form id="uploadForm" enctype="multipart/form-data" style="text-align:center; margin-top:20px;">
    <input type="file" name="file" accept="image/*" required>
    <br><br>
    <button type="submit">Predict</button>
    <button type="button" onclick="clearForm()">Clear</button>
</form>

<div id="loading" style="display:none; text-align:center; margin-top:20px;">
  <div class="spinner"></div>
  <p>Model is predicting... please wait</p>
</div>

<div id="result" class="result-box" style="display:none; text-align:center; margin-top:20px;"></div>

<script>
const form = document.getElementById("uploadForm");
const loading = document.getElementById("loading");
const result = document.getElementById("result");
const fileInput = document.querySelector('input[name="file"]');

form.addEventListener("submit", function(e){
    e.preventDefault();
    
    // Check if a file has been selected
    if (fileInput.files.length === 0) {
        alert("Please select a file to upload.");
        return;
    }

    const formData = new FormData();
    // Use .append() to explicitly add the file to the form data
    formData.append("file", fileInput.files[0]);

    loading.style.display = "block";
    result.style.display = "none";

    fetch("/predict", { method: "POST", body: formData })
    .then(res => {
        if (!res.ok) {
            // Throw an error if the HTTP status is not 2xx, which means the backend crashed
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        loading.style.display = "none";
        
        // Handle the prediction result or any backend error message
        if(data.error){
            result.style.display = "block";
            result.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
        } else {
            result.style.display = "block";
            result.innerHTML = `<h4>Prediction:</h4><p>${data.prediction}</p>`;
        }
    })
    .catch(error => {
        // Log the error and display it to the user
        loading.style.display = "none";
        result.style.display = "block";
        result.innerHTML = `<p style="color:red;">An error occurred: ${error.message}</p>`;
        console.error('Fetch error:', error);
    });
});

function clearForm(){
    form.reset();
    result.style.display = "none";
}
</script>

{% endblock %}